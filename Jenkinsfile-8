/* Second pipeline, Task 3, step 1 */

pipeline {
    agent any
    tools {
        maven 'maven'
    }
    environment {
        DOCKERHUB_CREDENTIALS = credentials('jacek-docker') 
    }
    stages {
        stage('Maven build') {
            steps {
                sh 'mvn clean package'
            }
        }
        stage('Docker Build') {
            steps {
                sh 'docker build -t jacekcracow/abctechnologies-latest-with-ansible:${BUILD_NUMBER} .'
            }
        }
        stage('Build and Deploy with Ansible') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'jacek-docker', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
                                     sshUserPrivateKey(credentialsId: 'ansible-ssh-key', usernameVariable: 'SSH_USER')]) {

                        def privateKey = credentials('ansible-ssh-key').privateKey.toString() // Convert to String

                        sshagent([privateKey]) {
                            sh """
                                ssh -o StrictHostKeyChecking=no \$SSH_USER@kmaster "ansible-playbook /home/jacek/ansible/docker-deploy8.yml -i /home/jacek/ansible/hosts -e build_number=${BUILD_NUMBER} -e docker_username=\${USERNAME} -e docker_password=\${PASSWORD}"
                            """
                        }
                    }
                }
            }
        }
    }
}
